# GitHub Organization License Audit Tool

This GitHub CLI Extension is designed to audit the licenses of dependencies within a GitHub organization. It enables you to generate a CSV file containing all packages used within an organization and their corresponding licenses.

![Screenshot of an output CSV](./docs/dependencies-csv.png)

After identifying any unwanted licenses or dependencies, you can utilize the [Dependency Graph](https://docs.github.com/en/code-security/supply-chain-security/understanding-your-software-supply-chain/about-the-dependency-graph) to locate all repositories in your organization that are using these dependencies.

## Getting Started

### ⚡️ Requirements

- [Python][python] `>= 3.10`
- [pip][python-pip] `>= 23.x`
  - `pip install ghastoolkit` (`>= 0.10.0`)
- [gh-cli][gh-cli]
- [GitHub Personal Access Token (PAT)][pats]
  - scoped to the organization you want to audit
  - allowed access to **All repositories**
  - and the Repository Permissions `Metadata` and `Contents` set to `read-only`

### 📦 Installing

This is a [GitHub CLI](gh-cli) Extension. To install and setup the CLI tool, you can use the following commands:

```bash
# install extension
gh extension install davelosert/gh-org-license-audit

# install deps (ghastoolkit)
gh org-license-audit install

# run
gh org-license-audit --help
```

### Upgrade

```bash
gh extension upgrade org-license-audit
```

## Usage

The tool currently supports two commands which you can run serially.

### Export Licenses

```shell
gh org-license-audit export-deps --org <org> --token <token> --target-csv <csv-file-path>

## The Token can also be provided as ENV Variable. The Target CSV is optional
GITHUB_TOKEN=<token> gh org-license-audit export-deps --org <org>
```

This command exports the licenses of all dependencies in a GitHub organization to a CSV file.

> [!IMPORTANT]
> For large organizations, this command may take several hours to run. It needs to fetch all the [SBOMs][sboms] from all the repositories in the organization, while respecting the primary and secondary [GitHub API Rate Limits][rate-limits].

You can run this command with the following options:

| Option       | Description                                                                         | Default Value    |
| ------------ | ----------------------------------------------------------------------------------- | ---------------- |
| --github-org | The name of the GitHub organization to audit.                                       | None             |
| --token      | Your GitHub API token. Can also be provided through the env variable `GITHUB_TOKEN` | None             |
| --target-csv | The path to the CSV file to write the licenses to.                                  | dependencies.csv |

> [!NOTE]
> This command may generate 404 errors during execution. These errors occur when a repository is encountered where the [Dependency Graph][dependency-graph] is disabled. These errors can be disregarded, but be aware that no dependency or license information can be collected for these repositories.

![Screenshot of a 404 Error which can happen during running this script](../docs/404-error.png)

### Aggregate Licenses

```shell
gh org-license-audit aggregate-licenses --source-csv <csv-file-path> --target-csv <csv-file-path>
```

This command aggregates all licenses previously identified by the `export-deps` command and creates a new CSV file containing all licenses and a count of the packages that use them.

You can run this command with the following options:

| Option       | Description                                                      | Default Value    |
| ------------ | ---------------------------------------------------------------- | ---------------- |
| --source-csv | The path to the CSV file generated by the `export-deps` command. | dependencies.csv |
| --target-csv | The path to the CSV file to write the aggregated licenses to.    | licenses.csv     |

## 📄 License

This project is licensed under the MIT License - see the [LICENSE](./LICENSE) file for details.

[python]: https://www.python.org/
[python-pip]: https://pip.pypa.io/en/stable
[gh-cli]: https://cli.github.com/
[pats]: https://docs.github.com/en/enterprise-cloud@latest/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens#fine-grained-personal-access-tokens
[rate-limits]: https://docs.github.com/en/enterprise-cloud@latest/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens#fine-grained-personal-access-tokens
[dependency-graph]: https://docs.github.com/en/enterprise-cloud@latest/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens#fine-grained-personal-access-tokens
